### Random Coffee Bot

---

## Описание проекта
Этот бот организует случайные встречи между участниками чата. Он автоматически формирует пары, отправляет опросы и уведомления, а также хранит данные в базе данных SQLite. Для логирования используется loguru, для конфигурации используется yaml. Проект упакован в docker-compose.

---

## Установка и настройка

### 1. Требования
Для работы с проектом вам понадобятся:
- (Опционально) **Make**: Для удобства выполнения команд.

---

### 2. Скачивание репозитория
1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/p4nk4life/random_coffee_bot.git
   cd random_coffee_bot
   ```

---

### 3. Настройка конфигурационного файла
1. Измените файл `config.example.yaml` в корне проекта.

2. Заполните его необходимыми данными. Пример структуры:
   ```yaml
   bot_token: "YOUR_BOT_TOKEN"       # Токен вашего Telegram-бота
   admin_chat_id: 123456789          # ID администратора (для получения уведомлений)
   group_chat_id: 987654321          # ID группы, где работает бот
   ```
   - **ID администратора и группы**: Используйте любой бот или сервис для получения ID (например, зайти на [web.telegram](https://web.telegram.org/) в чат группы и скопировать ее айди из адресной строки).

---

### 4. Запуск проекта через Docker
Проект использует Docker для контейнеризации. Это позволяет легко запустить бота без необходимости настраивать среду разработки.

#### Шаг 1: Сборка Docker-образа
Соберите образ:
```bash
docker-compose build
```

#### Шаг 2: Запуск контейнера
Запустите контейнер в фоновом режиме:
```bash
docker-compose up -d
```

#### Шаг 3: Проверка работы
Проверьте статус контейнера:
```bash
docker ps
```

Если что-то пошло не так, просмотрите логи:
```bash
docker logs randomcoffee_bot
```

#### Шаг 4: Остановка контейнера
Чтобы остановить контейнер:
```bash
docker-compose down
```

---

### 5. Работа с Makefile
В проекте используется `Makefile` для упрощения выполнения команд. Если у вас установлен `make`, вы можете использовать следующие команды:

- **Собрать Docker-образ**:
  ```bash
  make build
  ```

- **Запустить контейнер**:
  ```bash
  make up
  ```

- **Остановить контейнер**:
  ```bash
  make down
  ```

- **Просмотреть логи**:
  ```bash
  make logs
  ```

- **Очистить все Docker-ресурсы**:
  ```bash
  make clean
  ```

---

Если `make` не установлен, вы можете выполнять команды напрямую через `docker-compose`. Ниже список возможных команд для docker compose и makefile'а

---

### **1. Базовые команды**

#### **Собрать и запустить контейнер**
```bash
docker-compose up
```
- Собирает Docker-образ (если он еще не собран) и запускает контейнер.
- Логи выводятся в терминал.

#### **Запустить контейнер в фоновом режиме**
```bash
docker-compose up -d
```
- Запускает контейнер в фоновом режиме (`detached mode`).

#### **Остановить контейнер**
```bash
docker-compose down
```
- Останавливает и удаляет контейнеры, сети и тома (если они не указаны как внешние).

---

### **2. Работа с образами**

#### **Пересобрать образ**
```bash
docker-compose build
```
- Пересобирает Docker-образ на основе изменений в `Dockerfile`.

#### **Пересобрать образ и запустить контейнер**
```bash
docker-compose up --build
```
- Принудительно пересобирает образ перед запуском контейнера.

---

### **3. Просмотр состояния**

#### **Проверить статус контейнеров**
```bash
docker-compose ps
```
- Показывает список запущенных контейнеров и их состояние.

#### **Просмотреть логи контейнера**
```bash
docker-compose logs
```
- Выводит логи всех контейнеров, описанных в `docker-compose.yml`.

#### **Просмотреть логи конкретного сервиса**
```bash
docker-compose logs <имя_сервиса>
```
- Например:
  ```bash
  docker-compose logs randomcoffee_bot
  ```

---

### **4. Управление контейнерами**

#### **Остановить контейнер без удаления**
```bash
docker-compose stop
```
- Останавливает контейнеры, но не удаляет их.

#### **Запустить остановленный контейнер**
```bash
docker-compose start
```
- Запускает ранее остановленные контейнеры.

#### **Перезапустить контейнер**
```bash
docker-compose restart
```
- Перезапускает все контейнеры.

---

### **5. Очистка ресурсов**

#### **Удалить контейнеры, сети и тома**
```bash
docker-compose down --volumes
```
- Удаляет контейнеры, сети и тома, связанные с проектом.

#### **Удалить все Docker-ресурсы**
```bash
docker-compose down --rmi all --volumes --remove-orphans
```
- Удаляет:
  - Контейнеры.
  - Образы.
  - Тома.
  - "Сиротские" контейнеры (не описанные в `docker-compose.yml`).

---

### **6. Выполнение команд внутри контейнера**

#### **Выполнить команду внутри контейнера**
```bash
docker-compose exec <имя_сервиса> <команда>
```
- Например:
  ```bash
  docker-compose exec randomcoffee_bot bash
  ```
  Открывает интерактивную сессию Bash внутри контейнера.

#### **Выполнить одноразовую команду**
```bash
docker-compose run <имя_сервиса> <команда>
```
- Например:
  ```bash
  docker-compose run randomcoffee_bot python main.py
  ```

---

### **7. Дополнительные команды**

#### **Проверить конфигурацию `docker-compose.yml`**
```bash
docker-compose config
```
- Проверяет корректность файла `docker-compose.yml`.

#### **Просмотреть используемые порты**
```bash
docker-compose port <имя_сервиса> <порт>
```
- Например:
  ```bash
  docker-compose port randomcoffee_bot 8000
  ```

#### **Очистить неиспользуемые образы и кэш**
```bash
docker system prune -a
```
- Удаляет все неиспользуемые образы, контейнеры, сети и кэш.

---

### **Пример использования Makefile**

```makefile
# Переменные
PROJECT_NAME = randomcoffee_bot

# Цели (targets)

# Собрать Docker-образ
build:
	docker-compose build

# Запустить контейнер в фоновом режиме
up:
	docker-compose up -d

# Остановить контейнер
down:
	docker-compose down

# Просмотреть логи контейнера
logs:
	docker-compose logs $(PROJECT_NAME)

# Проверить статус контейнера
status:
	docker-compose ps

# Пересобрать и перезапустить контейнер
rebuild: down build up

# Очистить все Docker-ресурсы (контейнеры, образы, сети)
clean:
	docker-compose down --rmi all --volumes --remove-orphans

# Помощь
help:
	@echo "Доступные команды:"
	@echo "  make build   - Собрать Docker-образ"
	@echo "  make up      - Запустить контейнер"
	@echo "  make logs    - Просмотреть логи"
	@echo "  make down    - Остановить контейнер"
	@echo "  make status  - Проверить статус контейнера"
	@echo "  make rebuild - Пересобрать и перезапустить контейнер"
	@echo "  make clean   - Очистить все Docker-ресурсы"
	@echo "  make help    - Показать эту справку"
```

Можно использовать команды, например:
```bash
make build
make up
```

---

### 6. База данных

Бот использует SQLite для хранения данных. Файл базы данных (`random_coffee.db`) хранится в корневой директории вашего проекта на хосте и монтируется в контейнер через Docker-том:

```yaml
volumes:
  - ./random_coffee.db:/app/random_coffee.db
```

Это означает, что все изменения в базе данных будут сохраняться локально, даже если контейнер будет остановлен или удален.

---
